"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.ConsistentHashRing = void 0;
const node_crypto_1 = require("node:crypto");
class ConsistentHashRing {
    constructor(virtualNodes = 150) {
        this.virtualNodes = virtualNodes;
        this.ring = new Map();
        this.sortedKeys = [];
    }
    addNode(nodeId) {
        for (let i = 0; i < this.virtualNodes; i++) {
            const hash = this.hash(`${nodeId}:vn${i}`);
            this.ring.set(hash, nodeId);
        }
        this.sortedKeys = [...this.ring.keys()].sort((a, b) => a - b);
    }
    removeNode(nodeId) {
        for (let i = 0; i < this.virtualNodes; i++) {
            const hash = this.hash(`${nodeId}:vn${i}`);
            this.ring.delete(hash);
        }
        this.sortedKeys = [...this.ring.keys()].sort((a, b) => a - b);
    }
    getNodes(key, count = 1) {
        if (this.ring.size === 0)
            return [];
        const keyHash = this.hash(key);
        const result = [];
        const seen = new Set();
        let idx = this.binarySearch(keyHash);
        let attempts = 0;
        while (result.length < count && attempts < this.sortedKeys.length) {
            const ringKey = this.sortedKeys[idx % this.sortedKeys.length];
            const nodeId = this.ring.get(ringKey);
            if (!seen.has(nodeId)) {
                seen.add(nodeId);
                result.push(nodeId);
            }
            idx++;
            attempts++;
        }
        return result;
    }
    getNode(key) {
        var _a;
        const nodes = this.getNodes(key, 1);
        return (_a = nodes[0]) !== null && _a !== void 0 ? _a : null;
    }
    hash(input) {
        const h = (0, node_crypto_1.createHash)('md5').update(input).digest('hex');
        return parseInt(h.substring(0, 8), 16);
    }
    binarySearch(target) {
        let lo = 0, hi = this.sortedKeys.length - 1;
        while (lo <= hi) {
            const mid = Math.floor((lo + hi) / 2);
            if (this.sortedKeys[mid] < target)
                lo = mid + 1;
            else
                hi = mid - 1;
        }
        return lo % this.sortedKeys.length;
    }
}
exports.ConsistentHashRing = ConsistentHashRing;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY29uc2lzdGVudC1oYXNoLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vc3JjL2NvcmUvY29uc2lzdGVudC1oYXNoLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7OztBQUFBLDZDQUF5QztBQUV6QyxNQUFhLGtCQUFrQjtJQUkxQixZQUE2QixlQUFlLEdBQUc7UUFBbEIsaUJBQVksR0FBWixZQUFZLENBQU07UUFIdkMsU0FBSSxHQUFHLElBQUksR0FBRyxFQUFrQixDQUFDO1FBQ2pDLGVBQVUsR0FBYSxFQUFFLENBQUM7SUFFaUIsQ0FBQztJQUVwRCxPQUFPLENBQUMsTUFBYztRQUNqQixLQUFLLElBQUksQ0FBQyxHQUFHLENBQUMsRUFBRSxDQUFDLEdBQUcsSUFBSSxDQUFDLFlBQVksRUFBRSxDQUFDLEVBQUUsRUFBRSxDQUFDO1lBQ3hDLE1BQU0sSUFBSSxHQUFHLElBQUksQ0FBQyxJQUFJLENBQUMsR0FBRyxNQUFNLE1BQU0sQ0FBQyxFQUFFLENBQUMsQ0FBQztZQUMzQyxJQUFJLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxJQUFJLEVBQUUsTUFBTSxDQUFDLENBQUM7UUFDakMsQ0FBQztRQUNELElBQUksQ0FBQyxVQUFVLEdBQUcsQ0FBQyxHQUFHLElBQUksQ0FBQyxJQUFJLENBQUMsSUFBSSxFQUFFLENBQUMsQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxFQUFFLEVBQUUsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUM7SUFDbkUsQ0FBQztJQUVELFVBQVUsQ0FBQyxNQUFjO1FBQ3BCLEtBQUssSUFBSSxDQUFDLEdBQUcsQ0FBQyxFQUFFLENBQUMsR0FBRyxJQUFJLENBQUMsWUFBWSxFQUFFLENBQUMsRUFBRSxFQUFFLENBQUM7WUFDeEMsTUFBTSxJQUFJLEdBQUcsSUFBSSxDQUFDLElBQUksQ0FBQyxHQUFHLE1BQU0sTUFBTSxDQUFDLEVBQUUsQ0FBQyxDQUFDO1lBQzNDLElBQUksQ0FBQyxJQUFJ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